---
title: "ANTH630: Week 4 - Visualizing data"
output: 
  learnr::tutorial:
    progressive: true
runtime: shiny_prerendered
tutorial:
  id: "Week4VisualizingData"
  version: 0.5
---

```{r setup, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(exercise.checker = gradethis::grade_learnr)
knitr::opts_chunk$set(echo = TRUE)
learnr::tutorial_options(
  exercise.timelimit = 30)
```

Tutorial written by Madeline Brown and modified for learnr

### Useful Links
* [R Graph Gallery](https://www.r-graph-gallery.com/)
* [R Graphics Cookbook](https://r-graphics.org/)

<a class="btn btn-primary btn-sm" href="https://maddiebrown.github.io/ANTH630/ANTH630syllabus.html" role="button">ANTH630 Home</a>


## Getting started with ggplot2

Unlike plotting with base R, `ggplot2` relies on adding different layers onto a plot one at a time to create a complete figure. These layers are called `geoms`, and include axes, labels, points, or other information. The aesthetics of `geoms` are further customized with the `aes()` argument. 

```{r}
library(ggplot2)
```

### Creating a plot in layers

In ggplot2, figures are created one layer at a time. Let's work with the `diamonds` dataset to explore ggplot2's functions.

```{r}
ggplot(diamonds, aes(carat,price))
```

This output gives us an empty plot. One thing to notice is that the axis limits are set for the data referenced in the `aes()` argument, though the points are not plotted.

Now we can add in points with the `geom_point()` function.
```{r}
ggplot(diamonds, aes(carat,price)) + geom_point()
```

You can also plot multiple layers of data on the same plot.
```{r}

ggplot(diamonds, aes(carat,price)) + geom_point() + geom_smooth()

```

Let's finish the plot with some descriptive labels.

```{r}

ggplot(diamonds, aes(carat,price)) + geom_point() + geom_smooth() + ggtitle("Diamond prices by carat") + labs(x="Carat", y="Price (USD)")

```

Now you've mastered building plots in layers.

### Customizing aesthetics 
There are multiple aesthetic parameters that can be customized in ggplots. This includes: color, fill, linetype, size, shape, font, and more. It just depends on which `geom` you are working with. We will explore some of these graphical parameters further as this tutorial introduces different geoms. [Here](https://ggplot2.tidyverse.org/articles/ggplot2-specs.html) is a vignette about aesthetic customization in ggplot2.


### Different geoms

```{r eval=FALSE}

geom_col()
geom_point()
geom_line()
geom_smooth()
geom_histogram()
geom_boxplot()
geom_text()
geom_density()
geom_errorbar()
geom_hline()
geom_abline()

```

## Bar plots

Bar plots are great for showing frequencies or proportions across different groups. Let's return to the otter dataset we analyzed last week. First, let's calculate the total number of otters observed per site and then plot this in a bargraph with `ggplot2`.
```{r}
otter <- read.csv("https://maddiebrown.github.io/ANTH630/data/sea_otter_counts_2017&2018_CLEANDATA.csv")
notterpersite <- aggregate(x=n_otter ~ site_name, FUN=sum, data=otter)
ggplot(notterpersite, aes(x=site_name, y=n_otter)) + geom_col()
```

### Try it
Hmm...there are way too many columns in the plot above to make it a meaningful barchart. Subset out the top 5 sites with the most otter sightings and recreate the above chart. 

This particular exercise requires you to type the exact code as the solution. Try thinking about how to do it first, then click on solution to see the exact code that will earn a correct submission. Of course there are other variable names or ways to do it.
```{r prepare-otter}
otter <- read.csv("https://maddiebrown.github.io/ANTH630/data/sea_otter_counts_2017&2018_CLEANDATA.csv")
notterpersite <- aggregate(x=n_otter ~ site_name, FUN=sum, data=otter)
ggplot(notterpersite, aes(x=site_name, y=n_otter)) + geom_col()
```

```{r exercise1-1, exercise.setup="prepare-otter", exercise = TRUE}
# notterpersite <-
# top5 <-
```

```{r exercise1-1-solution}
notterpersite<- notterpersite[order(notterpersite$n_otter,decreasing=T),]
top5 <- notterpersite[1:5,]
ggplot(top5, aes(x=site_name, y=n_otter)) + geom_col()
```

```{r exercise1-1-check}
grade_code()
```


Alright, this figure is looking better. But suppose we want to reorder the categories on the X-axis such that they are in order from fewest to greatest number of otter sightings?

The site names are currently a factor column. This means there are ordered levels within the variable. We can reorder the levels of the factor according to the value in the n_otter column. First, inspect the structure of the site_name data. How many factor levels are there? Why do you think this is the case? 

Our first step is to drop all the extra levels. You'll notice that the remaining factors are in alphabetical order. 

```{r, include=FALSE}
# this code is to include the notterpersite and top5 variables in the tutorial's R session 
# so the next code chunk has access to them. The exercises have their own R session
# so the other code chunk's won't be able to exercise the variables defined there.
notterpersite<- notterpersite[order(notterpersite$n_otter,decreasing=T),]
top5 <- notterpersite[1:5,]
```

```{r}
str(top5$site_name)
top5$site_name<-reorder(top5$site_name,top5$n_otter)
p1 <- ggplot(top5, aes(x=site_name, y=n_otter)) + geom_col()
p1
```

You can also reorder factors with the `levels` argument of the `factor()` function.

## Working with axes and labels

R will usually make default x and y limits, but sometimes we want to manually adjust these ranges. Let's adjust the ylimit of our otter plot to 500. In reality, we wouldn't want to adjust the axes in this case, but this represents the principle.

```{r}
p1 + ylim(0,500)
```

We can also flip the x and y coordinates. 
```{r}
p1 + coord_flip()

```

### Try it {data-allow-skip=TRUE}

Using the `breaks` and `labels` arguments in the `scale_y_continuous()` function, change the labels in the otter plot to any text of your choosing. Finish your plot with a `ggtitle()`

```{r prepare-p1, exercise.setup="prepare-otter", include=FALSE}
# chain exercise setup from previous exercise
notterpersite<- notterpersite[order(notterpersite$n_otter,decreasing=T),]
top5 <- notterpersite[1:5,]

top5$site_name<-reorder(top5$site_name,top5$n_otter)
p1 <- ggplot(top5, aes(x=site_name, y=n_otter)) + geom_col()
```

```{r exercise2-1, exercise.setup="prepare-p1", exercise = TRUE}

```

```{r exercise2-1-solution}
p1 + scale_y_continuous(breaks = c(50,100,150,200,250,300), labels=c("a few","some","more","a bunch","a lot","a ton")) + ggtitle("Otter Counts")
```

## Working with colors

With ggplot you can customize the colors of different components of the graph in numerous ways. Let's work with the otters graph we just made to see how ggplot understands color arguments.

### Try it {data-allow-skip=TRUE}

1. Using the fill and color arguments in geom_col, add colors to the otter plot.

```{r exercise3-1, exercise.setup="prepare-p1", exercise = TRUE}

```

```{r exercise3-1-solution}
ggplot(top5, aes(x=site_name, y=n_otter)) + geom_col(fill="firebrick", color="lightsalmon2")
```

2. What happens if you put the same arguments into the aes() argument of the ggplot() function?
```{r exercise3-2, exercise.setup="prepare-p1", exercise = TRUE}

```

```{r exercise3-2-solution}
ggplot(top5, aes(x=site_name, y=n_otter, fill="firebrick", color="lightsalmon2")) + geom_col()
```

3. What happens if you assign "fill" to the site name variable?
```{r exercise3-3, exercise.setup="prepare-p1", exercise = TRUE}

```

```{r exercise3-3-solution}
ggplot(top5, aes(x=site_name, y=n_otter, fill=site_name)) + geom_col()

ggplot(top5, aes(x=site_name, y=n_otter)) + geom_col(aes(fill=site_name))
```
